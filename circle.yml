machine:
  services:
    - docker
  environment:
    AWS_DEFAULT_REGION: eu-west-2
    ECR_REPOSITORY: 613903586696.dkr.ecr.eu-west-2.amazonaws.com/wp/imbmembers
dependencies:
  override:
    - eval $(aws ecr get-login --region $AWS_DEFAULT_REGION)
    - docker build --rm=false -t $ECR_REPOSITORY:$CIRCLE_SHA1 . | cat
test:
  override:
    - /bin/true
deployment:
  # Build & push release
  release:
    tag: /[0-9]+\.[0-9]+\.[0-9]+/
    commands:
      - docker tag $ECR_REPOSITORY:$CIRCLE_SHA1 $ECR_REPOSITORY:tag-$CIRCLE_TAG
      - docker push $ECR_REPOSITORY:tag-$CIRCLE_TAG | cat
  # Build, push & deploy develop branch
  develop:
    branch: develop
    commands:
      - docker tag $ECR_REPOSITORY:$CIRCLE_SHA1 $ECR_REPOSITORY:branch-$CIRCLE_BRANCH
      - docker push $ECR_REPOSITORY:branch-$CIRCLE_BRANCH | cat
      - CF_STACK="ot-hillsborough-2" CLUSTER="wordpress" IMAGE="$ECR_REPOSITORY:branch-$CIRCLE_BRANCH" ./deploy-update.sh
  # Build & push all other branches
  branches:
    branch: /.*/
    commands:
      - docker tag $ECR_REPOSITORY:$CIRCLE_SHA1 $ECR_REPOSITORY:branch-$CIRCLE_BRANCH
      - docker push $ECR_REPOSITORY:branch-$CIRCLE_BRANCH | cat
